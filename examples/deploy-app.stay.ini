# Sapply Example - SvelteKit + Go Backend Deployment
# Real-world example: Deploy a SvelteKit frontend with Go backend

[env:production]
hosts=web1,web2
apps=deploy_backend,deploy_frontend,configure_nginx
concurrency=true

[env:staging]
hosts=staging-server
apps=deploy_backend,deploy_frontend,configure_nginx
concurrency=true

# Production hosts
[host:web1]
agent_id=web1.example.com
tags=production,web

[host:web2]
agent_id=web2.example.com
tags=production,web

[host:staging-server]
agent_id=staging.example.com
tags=staging

# Deploy Go backend binary
[app:deploy_backend]
step1=cmd:systemctl stop myapp-backend || true
step2=write_file:/opt/myapp/backend mode=0755 content="{{BINARY_PLACEHOLDER}}"
step3=write_file:/etc/systemd/system/myapp-backend.service mode=0644 content="[Unit]\nDescription=MyApp Backend\nAfter=network.target\n\n[Service]\nExecStart=/opt/myapp/backend\nRestart=always\nUser=www-data\n\n[Install]\nWantedBy=multi-user.target"
step4=systemd:daemon-reload
step5=systemd:enable myapp-backend.service
step6=systemd:start myapp-backend.service

# Deploy SvelteKit static build
[app:deploy_frontend]
step1=cmd:mkdir -p /var/www/myapp
step2=cmd:rsync -av --delete /tmp/myapp-frontend/ /var/www/myapp/
step3=cmd:chown -R www-data:www-data /var/www/myapp

# Configure nginx reverse proxy
[app:configure_nginx]
step1=template_file:/etc/nginx/sites-available/myapp mode=0644 template="server {\n    listen 80;\n    server_name {{.domain}};\n\n    location / {\n        root /var/www/myapp;\n        try_files $uri $uri/ /index.html;\n    }\n\n    location /api {\n        proxy_pass http://127.0.0.1:8080;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n}" vars={"domain":"myapp.example.com"}
step2=cmd:ln -sf /etc/nginx/sites-available/myapp /etc/nginx/sites-enabled/
step3=cmd:nginx -t
step4=systemd:reload nginx.service
